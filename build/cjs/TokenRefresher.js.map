{
  "version": 3,
  "sources": ["../esm/TokenRefresher.js"],
  "sourcesContent": ["/**\n * This file implements a TokenRefresher class that manages OAuth2 access tokens for an ioBroker adapter.\n *\n * Instructions: https://github.com/ioBroker/ioBroker.admin/blob/master/packages/jsonConfig/OAUTH2.md\n */\nimport { request } from 'node:https';\n/**\n * TokenRefresher class manages OAuth2 access tokens for an ioBroker adapter.\n */\nexport class TokenRefresher {\n    adapter;\n    stateName;\n    refreshTokenTimeout;\n    accessToken;\n    url;\n    readyPromise;\n    name;\n    /** Threshold in milliseconds before the access token expires to trigger a refresh */\n    static TOKEN_REFRESH_THRESHOLD_MS = 180_000; // 3 minutes in milliseconds\n    /**\n     * Creates an instance of TokenRefresher.\n     *\n     * @param adapter Instance of ioBroker adapter\n     * @param serviceName Name of the service for which the tokens are managed, e.g., 'spotify', 'dropbox', etc.\n     * @param stateName Optional name of the state where tokens are stored. Defaults to 'oauth2Tokens' and that will store tokens in `ADAPTER.X.oauth2Tokens`.\n     */\n    constructor(adapter, serviceName, stateName) {\n        this.adapter = adapter;\n        this.stateName = stateName || 'oauth2Tokens';\n        this.url = `https://oauth2.iobroker.in/${serviceName}`;\n        this.name = serviceName || adapter.name;\n        if (this.name === 'oauth2') {\n            this.name = adapter.name;\n        }\n        this.readyPromise = this.init();\n    }\n    httpPost(url, data, timeout = 20_000) {\n        return new Promise((resolve, reject) => {\n            const req = request(url, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    'Content-Length': Buffer.byteLength(JSON.stringify(data)),\n                },\n                timeout,\n            }, res => {\n                let responseData = '';\n                res.on('data', chunk => {\n                    responseData += chunk;\n                });\n                res.on('end', () => {\n                    if (res.statusCode === 200 || res.statusCode === 201) {\n                        resolve(JSON.parse(responseData));\n                    }\n                    else {\n                        reject(new Error(`HTTP ${res.statusCode}: ${responseData}`));\n                    }\n                });\n                res.on('error', reject);\n            });\n            req.on('error', error => reject(error));\n            req.write(JSON.stringify(data));\n            req.end();\n        });\n    }\n    async init() {\n        // Check if the object for the state exists, if not create it\n        const obj = await this.adapter.getObjectAsync(this.stateName);\n        if (!obj) {\n            await this.adapter.setObjectAsync(this.stateName, {\n                type: 'state',\n                common: {\n                    name: this.stateName,\n                    expert: true,\n                    type: 'string',\n                    role: 'json',\n                    read: true,\n                    write: true,\n                    def: '',\n                },\n                native: {},\n            });\n            this.adapter.log.debug(`State ${this.stateName} created for ${this.name}`);\n        }\n        const state = await this.adapter.getStateAsync(this.stateName);\n        if (state) {\n            try {\n                this.accessToken = JSON.parse(state.val);\n            }\n            catch (error) {\n                this.adapter.log.error(`Cannot parse tokens: ${state.val}: ${error.message}`);\n                this.accessToken = undefined;\n            }\n        }\n        else {\n            this.adapter.log.error(`No tokens for ${this.name} found`);\n        }\n        this.adapter\n            .subscribeStatesAsync(this.stateName)\n            .catch(error => this.adapter.log.error(`Cannot read tokens: ${error}`));\n        return this.refreshTokens().catch(error => this.adapter.log.error(`Cannot refresh tokens: ${error}`));\n    }\n    /**\n     * Destroys the TokenRefresher instance, clearing any timeouts and stopping state subscriptions.\n     */\n    destroy() {\n        if (this.refreshTokenTimeout) {\n            this.adapter.clearTimeout(this.refreshTokenTimeout);\n            this.refreshTokenTimeout = undefined;\n        }\n    }\n    /**\n     * This method is called when the state changes for the token.\n     *\n     * @param id ID of the state that changed\n     * @param state Value\n     */\n    onStateChange(id, state) {\n        if (state?.ack && id === `${this.adapter.namespace}.${this.stateName}`) {\n            if (JSON.stringify(this.accessToken) !== state.val) {\n                try {\n                    this.accessToken = JSON.parse(state.val);\n                    this.refreshTokens().catch(error => this.adapter.log.error(`Cannot refresh tokens: ${error}`));\n                }\n                catch (error) {\n                    this.adapter.log.error(`Cannot parse tokens: ${error}`);\n                    this.accessToken = undefined;\n                }\n            }\n        }\n    }\n    /** Returns the access token if it is valid and not expired.*/\n    async getAccessToken() {\n        await this.readyPromise;\n        if (!this.accessToken?.access_token) {\n            this.adapter.log.error(`No tokens for ${this.name} found`);\n            return undefined;\n        }\n        if (!this.accessToken.access_token_expires_on ||\n            new Date(this.accessToken.access_token_expires_on).getTime() < Date.now()) {\n            this.adapter.log.error('Access token is expired. Please authorize with your credentials via Admin interface again');\n            return undefined;\n        }\n        return this.accessToken.access_token;\n    }\n    async refreshTokens() {\n        if (this.refreshTokenTimeout) {\n            this.adapter.clearTimeout(this.refreshTokenTimeout);\n            this.refreshTokenTimeout = undefined;\n        }\n        if (!this.accessToken?.refresh_token) {\n            this.adapter.log.error(`No tokens for ${this.name} found. Please authorize anew with your credentials via Admin interface.`);\n            return;\n        }\n        if (!this.accessToken.access_token_expires_on ||\n            new Date(this.accessToken.access_token_expires_on).getTime() < Date.now()) {\n            this.adapter.log.debug('Access token is expired. Retrying to refresh tokens...');\n        }\n        let expiresIn = new Date(this.accessToken.access_token_expires_on).getTime() -\n            Date.now() -\n            TokenRefresher.TOKEN_REFRESH_THRESHOLD_MS;\n        // If expiration is in less than 3 minutes, refresh the token\n        if (expiresIn <= 0) {\n            // Refresh token\n            try {\n                this.accessToken = await this.httpPost(this.url, this.accessToken);\n            }\n            catch (error) {\n                this.accessToken = undefined;\n                this.adapter.log.error(`Cannot refresh tokens: ${error}`);\n            }\n            if (this.accessToken) {\n                this.accessToken.access_token_expires_on = new Date(Date.now() + this.accessToken.expires_in * 1_000).toISOString();\n                expiresIn = new Date(this.accessToken.access_token_expires_on).getTime() - Date.now() - 180_000;\n                await this.adapter.setState(this.stateName, JSON.stringify(this.accessToken), true);\n                this.adapter.log.debug(`Tokens for ${this.name} updated`);\n            }\n            else {\n                // Try again in 10 minutes\n                expiresIn = 600_000; // 10 minutes\n                this.adapter.log.error(`No tokens for ${this.name} could be refreshed`);\n            }\n        }\n        // no longer than 10 minutes, as longer timer could be not reliable\n        if (expiresIn > 600_000) {\n            expiresIn = 600_000;\n        }\n        else if (expiresIn < 60_000) {\n            expiresIn = 60_000;\n        }\n        this.refreshTokenTimeout = this.adapter.setTimeout(() => {\n            this.refreshTokenTimeout = undefined;\n            this.refreshTokens().catch(error => this.adapter.log.error(`Cannot refresh tokens: ${error}`));\n        }, expiresIn);\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA,wBAAwB;AAIjB,MAAM,eAAe;AAAA,EAT5B,OAS4B;AAAA;AAAA;AAAA,EACxB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAAA,EAEA,OAAO,6BAA6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQpC,YAAY,SAAS,aAAa,WAAW;AACzC,SAAK,UAAU;AACf,SAAK,YAAY,aAAa;AAC9B,SAAK,MAAM,8BAA8B,WAAW;AACpD,SAAK,OAAO,eAAe,QAAQ;AACnC,QAAI,KAAK,SAAS,UAAU;AACxB,WAAK,OAAO,QAAQ;AAAA,IACxB;AACA,SAAK,eAAe,KAAK,KAAK;AAAA,EAClC;AAAA,EACA,SAAS,KAAK,MAAM,UAAU,KAAQ;AAClC,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpC,YAAM,UAAM,2BAAQ,KAAK;AAAA,QACrB,QAAQ;AAAA,QACR,SAAS;AAAA,UACL,gBAAgB;AAAA,UAChB,kBAAkB,OAAO,WAAW,KAAK,UAAU,IAAI,CAAC;AAAA,QAC5D;AAAA,QACA;AAAA,MACJ,GAAG,SAAO;AACN,YAAI,eAAe;AACnB,YAAI,GAAG,QAAQ,WAAS;AACpB,0BAAgB;AAAA,QACpB,CAAC;AACD,YAAI,GAAG,OAAO,MAAM;AAChB,cAAI,IAAI,eAAe,OAAO,IAAI,eAAe,KAAK;AAClD,oBAAQ,KAAK,MAAM,YAAY,CAAC;AAAA,UACpC,OACK;AACD,mBAAO,IAAI,MAAM,QAAQ,IAAI,UAAU,KAAK,YAAY,EAAE,CAAC;AAAA,UAC/D;AAAA,QACJ,CAAC;AACD,YAAI,GAAG,SAAS,MAAM;AAAA,MAC1B,CAAC;AACD,UAAI,GAAG,SAAS,WAAS,OAAO,KAAK,CAAC;AACtC,UAAI,MAAM,KAAK,UAAU,IAAI,CAAC;AAC9B,UAAI,IAAI;AAAA,IACZ,CAAC;AAAA,EACL;AAAA,EACA,MAAM,OAAO;AAET,UAAM,MAAM,MAAM,KAAK,QAAQ,eAAe,KAAK,SAAS;AAC5D,QAAI,CAAC,KAAK;AACN,YAAM,KAAK,QAAQ,eAAe,KAAK,WAAW;AAAA,QAC9C,MAAM;AAAA,QACN,QAAQ;AAAA,UACJ,MAAM,KAAK;AAAA,UACX,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,MAAM;AAAA,UACN,MAAM;AAAA,UACN,OAAO;AAAA,UACP,KAAK;AAAA,QACT;AAAA,QACA,QAAQ,CAAC;AAAA,MACb,CAAC;AACD,WAAK,QAAQ,IAAI,MAAM,SAAS,KAAK,SAAS,gBAAgB,KAAK,IAAI,EAAE;AAAA,IAC7E;AACA,UAAM,QAAQ,MAAM,KAAK,QAAQ,cAAc,KAAK,SAAS;AAC7D,QAAI,OAAO;AACP,UAAI;AACA,aAAK,cAAc,KAAK,MAAM,MAAM,GAAG;AAAA,MAC3C,SACO,OAAO;AACV,aAAK,QAAQ,IAAI,MAAM,wBAAwB,MAAM,GAAG,KAAK,MAAM,OAAO,EAAE;AAC5E,aAAK,cAAc;AAAA,MACvB;AAAA,IACJ,OACK;AACD,WAAK,QAAQ,IAAI,MAAM,iBAAiB,KAAK,IAAI,QAAQ;AAAA,IAC7D;AACA,SAAK,QACA,qBAAqB,KAAK,SAAS,EACnC,MAAM,WAAS,KAAK,QAAQ,IAAI,MAAM,uBAAuB,KAAK,EAAE,CAAC;AAC1E,WAAO,KAAK,cAAc,EAAE,MAAM,WAAS,KAAK,QAAQ,IAAI,MAAM,0BAA0B,KAAK,EAAE,CAAC;AAAA,EACxG;AAAA;AAAA;AAAA;AAAA,EAIA,UAAU;AACN,QAAI,KAAK,qBAAqB;AAC1B,WAAK,QAAQ,aAAa,KAAK,mBAAmB;AAClD,WAAK,sBAAsB;AAAA,IAC/B;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,cAAc,IAAI,OAAO;AACrB,QAAI,OAAO,OAAO,OAAO,GAAG,KAAK,QAAQ,SAAS,IAAI,KAAK,SAAS,IAAI;AACpE,UAAI,KAAK,UAAU,KAAK,WAAW,MAAM,MAAM,KAAK;AAChD,YAAI;AACA,eAAK,cAAc,KAAK,MAAM,MAAM,GAAG;AACvC,eAAK,cAAc,EAAE,MAAM,WAAS,KAAK,QAAQ,IAAI,MAAM,0BAA0B,KAAK,EAAE,CAAC;AAAA,QACjG,SACO,OAAO;AACV,eAAK,QAAQ,IAAI,MAAM,wBAAwB,KAAK,EAAE;AACtD,eAAK,cAAc;AAAA,QACvB;AAAA,MACJ;AAAA,IACJ;AAAA,EACJ;AAAA;AAAA,EAEA,MAAM,iBAAiB;AACnB,UAAM,KAAK;AACX,QAAI,CAAC,KAAK,aAAa,cAAc;AACjC,WAAK,QAAQ,IAAI,MAAM,iBAAiB,KAAK,IAAI,QAAQ;AACzD,aAAO;AAAA,IACX;AACA,QAAI,CAAC,KAAK,YAAY,2BAClB,IAAI,KAAK,KAAK,YAAY,uBAAuB,EAAE,QAAQ,IAAI,KAAK,IAAI,GAAG;AAC3E,WAAK,QAAQ,IAAI,MAAM,2FAA2F;AAClH,aAAO;AAAA,IACX;AACA,WAAO,KAAK,YAAY;AAAA,EAC5B;AAAA,EACA,MAAM,gBAAgB;AAClB,QAAI,KAAK,qBAAqB;AAC1B,WAAK,QAAQ,aAAa,KAAK,mBAAmB;AAClD,WAAK,sBAAsB;AAAA,IAC/B;AACA,QAAI,CAAC,KAAK,aAAa,eAAe;AAClC,WAAK,QAAQ,IAAI,MAAM,iBAAiB,KAAK,IAAI,0EAA0E;AAC3H;AAAA,IACJ;AACA,QAAI,CAAC,KAAK,YAAY,2BAClB,IAAI,KAAK,KAAK,YAAY,uBAAuB,EAAE,QAAQ,IAAI,KAAK,IAAI,GAAG;AAC3E,WAAK,QAAQ,IAAI,MAAM,wDAAwD;AAAA,IACnF;AACA,QAAI,YAAY,IAAI,KAAK,KAAK,YAAY,uBAAuB,EAAE,QAAQ,IACvE,KAAK,IAAI,IACT,eAAe;AAEnB,QAAI,aAAa,GAAG;AAEhB,UAAI;AACA,aAAK,cAAc,MAAM,KAAK,SAAS,KAAK,KAAK,KAAK,WAAW;AAAA,MACrE,SACO,OAAO;AACV,aAAK,cAAc;AACnB,aAAK,QAAQ,IAAI,MAAM,0BAA0B,KAAK,EAAE;AAAA,MAC5D;AACA,UAAI,KAAK,aAAa;AAClB,aAAK,YAAY,0BAA0B,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,YAAY,aAAa,GAAK,EAAE,YAAY;AAClH,oBAAY,IAAI,KAAK,KAAK,YAAY,uBAAuB,EAAE,QAAQ,IAAI,KAAK,IAAI,IAAI;AACxF,cAAM,KAAK,QAAQ,SAAS,KAAK,WAAW,KAAK,UAAU,KAAK,WAAW,GAAG,IAAI;AAClF,aAAK,QAAQ,IAAI,MAAM,cAAc,KAAK,IAAI,UAAU;AAAA,MAC5D,OACK;AAED,oBAAY;AACZ,aAAK,QAAQ,IAAI,MAAM,iBAAiB,KAAK,IAAI,qBAAqB;AAAA,MAC1E;AAAA,IACJ;AAEA,QAAI,YAAY,KAAS;AACrB,kBAAY;AAAA,IAChB,WACS,YAAY,KAAQ;AACzB,kBAAY;AAAA,IAChB;AACA,SAAK,sBAAsB,KAAK,QAAQ,WAAW,MAAM;AACrD,WAAK,sBAAsB;AAC3B,WAAK,cAAc,EAAE,MAAM,WAAS,KAAK,QAAQ,IAAI,MAAM,0BAA0B,KAAK,EAAE,CAAC;AAAA,IACjG,GAAG,SAAS;AAAA,EAChB;AACJ;",
  "names": []
}
